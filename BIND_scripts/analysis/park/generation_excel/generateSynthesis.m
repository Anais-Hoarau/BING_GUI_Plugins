%Chargement du tripset sur le dossier qui contient tout les sujets
directory = uigetdir(pwd, 'Choisissez le chemin du dossier contenant tout les trips de PARK');
if directory == 0
    return;
end
%Choix du dossier de sortie
outDirectory = uigetdir(pwd, 'Choisissez le dossier de destination des fichiers générés');
if outDirectory == 0
    return;
end
tripsFolders = {'park01_100607_10h07/trip_park01.trip',...
                'park02_100608_10h02/trip_park02.trip', ...
                'park03_100610_10h03/trip_park03.trip',...
                'park04_100614_10h10/trip_park04.trip',...
                'park05_100615_10h09/trip_park05.trip',...
                'park06_100621_09h59/trip_park06.trip',...
                'park07_100622_10h13/trip_park07.trip',...
                'park08_100624_10h17/trip_park08.trip',...
                'park09_100628_10h23/trip_park09.trip',...
                'park10_100629_10h06/trip_park10.trip',...
                'park11_100701_10h31/trip_park11.trip',...
                'park12_100705_10h04/trip_park12.trip',...
                'park13_100706_10h34/trip_park13.trip',...
                'park14_100708_10h17/trip_park14.trip',...
                'park16_100914_10h02/trip_park16.trip',...
                'park17_101004_10h42/trip_park17.trip',...
                'park18_101011_10h10/trip_park18.trip',...
                'park20_101018_10h08/trip_park20.trip',...
                'park21_101019_10h20/trip_park21.trip',...
                'park22_101025_10h03/trip_park22.trip',...
                'park23_101026_10h18/trip_park23.trip',...
                'park24_101108_10h24/trip_park24.trip',...
                'park25_101109_10h07/trip_park25.trip',...
                'park26_101115_10h20/trip_park26.trip',...
                'park27_101116_10h08/trip_park27.trip',...
                'park28_101118_10h23/trip_park28.trip',...
                'park29_101122_10h16/trip_park29.trip',...
                'park30_101123_10h10/trip_park30.trip',...
                'park31_101125_10h22/trip_park31.trip',...
                'park32_101129_10h49/trip_park32.trip',...
                'park33_101130_10h15/trip_park33.trip',...
                'park34_101206_10h12/trip_park34.trip',...
                'park35_101207_10h11/trip_park35.trip',...
                'park36_110110_10h12/trip_park36.trip',...
                'park38_110411_10h06/trip_park38.trip',...
                'park39_110516_10h31/trip_park39.trip',...
                'park40_110517_08h11/trip_park40.trip',...
                };
                %'park19_101012_10h02/trip_park19.trip',...
                %'park15_100913_10h05/trip_park15.trip',...
                %'park37_110228_10h21/trip_park37.trip',...
numberOfTrips = length(tripsFolders);
trips = cell(numberOfTrips);
for i = 1:1:numberOfTrips
    completeFilePath = [directory filesep tripsFolders{i}];
    disp(['Chargement de ' completeFilePath]);
    trips{i} = fr.lescot.bind.kernel.implementation.SQLiteTrip(completeFilePath, 0.1, false);
end
disp([num2str(numberOfTrips) ' trips chargés']);
%On genère le premier tableau excel, qui contient les scores totaux par
%Maud et Laurence pour chaque patient
%Selection des trips codés en commun

xlsContent = cell(numberOfTrips + 1, 5);
xlsContent(1, 1) = {'Numero du trip'};
xlsContent(1, 2) = {'Sujet'};
xlsContent(1, 3) = {'Status'};
xlsContent(1, 4) = {'Score total Maud'};
xlsContent(1, 5) = {'Score total Laurence'};

for i = 1:1:numberOfTrips;
    trip = trips{i};
    disp(['Récupération des métadonnées du sujet ' num2str(i)]);
    participant = trip.getMetaInformations().getParticipant();

    driver = participant.getAttribute('Driver');
    xlsContent(i + 1, 1) = {driver};
    disp(['-- Driver : ' driver]); 

    numberStatus = participant.getAttribute('Number_status');
    xlsContent(i + 1, 2) = {numberStatus};
    disp(['-- Number status : ' numberStatus]); 

    status = participant.getAttribute('Status');
    xlsContent(i + 1, 3) = {status};
    disp(['-- Status : ' status]); 

    disp(['Calcul du score du sujet ' num2str(i)]);
    scoreMaud = 0;
    scoreLaurence = 0;
    codageMaud = trip.getAllSituationOccurences('errorSituationsByMaud');
    codageLaurence = trip.getAllSituationOccurences('errorSituationsByLaurence');
    variablesNames = codageMaud.getVariableNames();
    for j = 1:1:length(variablesNames)
        variableName = variablesNames{j};
       if ~any(strcmpi(variableName, {'Type', 'Label', 'startTimecode', 'endTimecode'}))
          scoreMaudForVariable = sum(cell2mat(codageMaud.getVariableValues(variableName)));
          scoreLaurenceForVariable = sum(cell2mat(codageLaurence.getVariableValues(variableName)));
          disp(['-- Score ' variableName ' (Maud) : ' num2str(scoreMaudForVariable)]);
          disp(['-- Score ' variableName ' (Laurence): ' num2str(scoreLaurenceForVariable)]);
          scoreMaud = scoreMaud + scoreMaudForVariable;
          scoreLaurence = scoreLaurence + scoreLaurenceForVariable;
       end
    end
    disp(['* Score total Maud : ' num2str(scoreMaud)]);
    disp(['* Score total Laurence : ' num2str(scoreLaurence)]);
    xlsContent(i + 1, 4) = {scoreMaud};
    xlsContent(i + 1, 5) = {scoreLaurence};

end
%Ecriture du tableau excel
xlswrite([outDirectory filesep 'synthese_park.xls'] , xlsContent);